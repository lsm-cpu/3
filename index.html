<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module 4: Social Issues Challenge</title>
    <style>
        :root {
            --primary: #5c6bc0; /* Indigo for a more academic/social issues feel */
            --secondary: #26a69a; /* Teal */
            --accent: #ff7043; /* Deep Orange */
            --bg: #eceff1;
            --card: #ffffff;
            --text: #37474f;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text);
        }

        .container {
            background: var(--card);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 95%;
            max-width: 800px;
            text-align: center;
        }

        h1 { color: var(--primary); margin-bottom: 0.5rem; }
        p { color: #546e7a; margin-top: 0; }

        /* Syllable Colors - Distinct for recognition */
        .syl-1 { color: #d32f2f; } /* Red */
        .syl-2 { color: #1976d2; } /* Blue */
        .syl-3 { color: #388e3c; } /* Green */
        .syl-4 { color: #e64a19; } /* Orange */
        .syl-5 { color: #7b1fa2; } /* Purple */
        
        .word-display {
            font-size: 3rem;
            font-weight: 700;
            margin: 2rem 0;
            padding: 1.5rem;
            background: #f5f5f5;
            border-radius: 12px;
            border: 2px solid #cfd8dc;
            letter-spacing: 1px;
        }

        /* Inputs & Buttons */
        .input-group { margin: 15px 0; }
        
        input {
            padding: 12px;
            margin: 5px;
            border: 1px solid #b0bec5;
            border-radius: 6px;
            font-size: 1rem;
            width: 200px;
        }

        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.2s;
            margin: 5px;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); filter: brightness(1.1); }
        .btn:disabled { background-color: #cfd8dc; cursor: not-allowed; transform: none; box-shadow: none; }

        .btn-mic {
            background-color: var(--accent);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            font-size: 2.5rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
        }
        
        .mic-listening { animation: pulse 1.5s infinite; background-color: #d32f2f; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(211, 47, 47, 0); }
            100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); }
        }

        /* Layout */
        .hidden { display: none !important; }
        
        .scoreboard {
            display: flex;
            justify-content: space-between;
            background: #e8eaf6;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
            color: var(--primary);
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 20px;
        }

        .option-card {
            background: white;
            border: 2px solid #e0e0e0;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
            text-align: left;
        }

        .option-card:hover { border-color: var(--primary); background: #e8eaf6; }

        .feedback { min-height: 24px; font-weight: bold; margin-top: 15px; font-size: 1.1rem; }

        /* Table */
        .results-table-container { max-height: 300px; overflow-y: auto; margin: 20px 0; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; }
        th { background-color: var(--primary); color: white; position: sticky; top: 0; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
    </style>
</head>
<body>

<div class="container">
    <div id="screen-login">
        <h1>Module 4: Social Issues & Solutions</h1>
        <p>Daily Vocab Challenge</p>
        
        <div class="input-group">
            <input type="text" id="sName" placeholder="Full Name (e.g., Chan Tai Man)">
            <br>
            <input type="text" id="sClass" placeholder="Class (e.g., 4A)" style="width: 90px;">
            <input type="number" id="sNo" placeholder="Class No." style="width: 90px;">
        </div>

        <h3>Select Your Level:</h3>
        <div>
            <button class="btn" onclick="startGame('Core')" style="background-color: #66bb6a;">Core (‚òÖ)</button>
            <button class="btn" onclick="startGame('Intermediate')" style="background-color: #ffa726;">Intermediate (‚òÖ‚òÖ)</button>
            <button class="btn" onclick="startGame('Advanced')" style="background-color: #ef5350;">Advanced (‚òÖ‚òÖ‚òÖ)</button>
        </div>
    </div>

    <div id="screen-game" class="hidden">
        <div class="scoreboard">
            <span>üó£Ô∏è Speaking: <span id="score-speak">0</span></span>
            <span>üß© Matching: <span id="score-match">0</span></span>
            <span>Progress: <span id="progress-text">1/10</span></span>
        </div>

        <div id="task-speak">
            <h2>Step 1: Listen & Read Aloud</h2>
            <div id="word-syllables" class="word-display"></div>
            
            <div>
                <button class="btn" onclick="playTTS()">üîä Listen</button>
            </div>
            
            <button class="btn btn-mic" id="mic-btn" onclick="activateMic()">üé§</button>
            <div id="mic-status" style="margin-top: 10px; color: #78909c;">Tap microphone to start</div>
            <div id="feedback-speak" class="feedback"></div>
        </div>

        <div id="task-match" class="hidden">
            <h2>Step 2: Match Meaning</h2>
            <div id="match-word-title" style="font-size: 2rem; font-weight: bold; color: var(--primary); margin: 20px 0;"></div>
            <div id="options-container" class="options-grid"></div>
            <div id="feedback-match" class="feedback"></div>
        </div>
    </div>

    <div id="screen-result" class="hidden">
        <h1>Daily Result</h1>
        <h2>Total Score: <span id="final-score"></span> / 20</h2>
        
        <div class="results-table-container">
            <table>
                <thead>
                    <tr>
                        <th>Word</th>
                        <th>Speak</th>
                        <th>Match</th>
                    </tr>
                </thead>
                <tbody id="result-tbody"></tbody>
            </table>
        </div>

        <button class="btn" onclick="exportCSV()">üì• Export CSV</button>
        <button class="btn" onclick="location.reload()" style="background-color: #78909c;">New Student</button>
    </div>
</div>

<script>
    // --- Data Configuration ---
    // Includes Syllable splits and Chinese/English meanings
    const vocabDB = {
        Core: [
            { w: "housing cost", syl: ["hous", "ing", " ", "cost"], m: "‰ΩèÂ±ãÊàêÊú¨ (The price of rent or buying a home)" },
            { w: "rent", syl: ["rent"], m: "ÁßüÈáë (Money paid to live in a flat)" },
            { w: "struggle with", syl: ["strug", "gle", " ", "with"], m: "Èù¢Â∞çÂõ∞Èõ£/ÊéôÊâé (To find something difficult)" },
            { w: "salary", syl: ["sal", "a", "ry"], m: "Ëñ™Èáë (Monthly payment for work)" },
            { w: "affordable", syl: ["af", "ford", "a", "ble"], m: "ÂèØË≤†ÊìîÁöÑ (Not too expensive)" },
            { w: "cure", syl: ["cure"], m: "Ê≤ªÁôí (To make someone healthy again)" },
            { w: "suffer", syl: ["suf", "fer"], m: "ÂèóËã¶ (To feel pain or sadness)" },
            { w: "single parents", syl: ["sin", "gle", " ", "par", "ents"], m: "ÂñÆË¶™ÂÆ∂Èï∑ (Mother or father raising kids alone)" },
            { w: "the homeless", syl: ["the", " ", "home", "less"], m: "ÁÑ°ÂÆ∂ÂèØÊ≠∏ËÄÖ (People without a home)" },
            { w: "the elderly", syl: ["the", " ", "eld", "er", "ly"], m: "Èï∑ËÄÖ (Old people)" },
            { w: "poverty", syl: ["pov", "er", "ty"], m: "Ë≤ßÁ™Æ (Being very poor)" },
            { w: "crime", syl: ["crime"], m: "ÁΩ™Ê°à (Illegal activities)" },
            { w: "loneliness", syl: ["lone", "li", "ness"], m: "Â≠§Áç® (Feeling sad because you are alone)" },
            { w: "social media addiction", syl: ["so", "cial", " ", "me", "dia", " ", "ad", "dic", "tion"], m: "Á§æ‰∫§Â™íÈ´îÊàêÁôÆ (Using social apps too much)" },
            { w: "resolve", syl: ["re", "solve"], m: "Ëß£Ê±∫ (To find a solution)" },
            { w: "ignore", syl: ["ig", "nore"], m: "ÂøΩË¶ñ (To not pay attention to)" }
        ],
        Intermediate: [
            { w: "economy", syl: ["e", "con", "o", "my"], m: "Á∂ìÊøü (System of money and goods)" },
            { w: "government officials", syl: ["gov", "ern", "ment", " ", "of", "fi", "cials"], m: "ÊîøÂ∫úÂÆòÂì° (People working in government)" },
            { w: "nutritious food", syl: ["nu", "tri", "tious", " ", "food"], m: "ÊúâÁáüÈ§äÁöÑÈ£üÁâ© (Healthy food)" },
            { w: "depressing", syl: ["de", "press", "ing"], m: "‰ª§‰∫∫Ê≤ÆÂñ™ÁöÑ (Making you feel sad)" },
            { w: "underweight", syl: ["un", "der", "weight"], m: "È´îÈáçÈÅéËºï (Too thin)" },
            { w: "low-paid", syl: ["low", "paid"], m: "‰ΩéËñ™ÁöÑ (Earning little money)" },
            { w: "the disabled", syl: ["the", " ", "dis", "a", "bled"], m: "ÊÆòÁñæ‰∫∫Â£´ (People with physical limits)" },
            { w: "the unemployed", syl: ["the", " ", "un", "em", "ployed"], m: "Â§±Ê•≠‰∫∫Â£´ (People without jobs)" },
            { w: "the uneducated", syl: ["the", " ", "un", "ed", "u", "ca", "ted"], m: "Êú™ÂèóÊïôËÇ≤ÁöÑ‰∫∫ (People with little schooling)" },
            { w: "ageing population", syl: ["age", "ing", " ", "pop", "u", "la", "tion"], m: "‰∫∫Âè£ËÄÅÂåñ (More and more old people)" },
            { w: "unemployment", syl: ["un", "em", "ploy", "ment"], m: "Â§±Ê•≠ (State of not having a job)" },
            { w: "high healthcare cost", syl: ["high", " ", "health", "care", " ", "cost"], m: "È´òÊòÇÈÜ´ÁôÇË≤ªÁî® (Expensive medical bills)" },
            { w: "drug abuse", syl: ["drug", " ", "a", "buse"], m: "Êø´Áî®Ëó•Áâ© (Using drugs badly)" },
            { w: "rectify", syl: ["rec", "ti", "fy"], m: "Á≥æÊ≠£ (To put right/correct)" }
        ],
        Advanced: [
            { w: "welfare payment", syl: ["wel", "fare", " ", "pay", "ment"], m: "Á¶èÂà©Èáë (Money from government for help)" },
            { w: "subdivided flats", syl: ["sub", "di", "vid", "ed", " ", "flats"], m: "ÂäèÊàø (Flat divided into small units)" },
            { w: "infectious diseases", syl: ["in", "fec", "tious", " ", "dis", "eas", "es"], m: "ÂÇ≥ÊüìÁóÖ (Illness that spreads)" },
            { w: "new immigrants", syl: ["new", " ", "im", "mi", "grants"], m: "Êñ∞ÁßªÊ∞ë (People recently moved here)" },
            { w: "ethnic minorities", syl: ["eth", "nic", " ", "mi", "nor", "i", "ties"], m: "Â∞ëÊï∏ÊóèË£î (Small racial/cultural groups)" },
            { w: "isolation", syl: ["i", "so", "la", "tion"], m: "Â≠§Á´ã (Being separated from others)" },
            { w: "gender inequality", syl: ["gen", "der", " ", "in", "e", "qual", "i", "ty"], m: "ÊÄßÂà•‰∏çÂπ≥Á≠â (Unfairness between men and women)" },
            { w: "malnutrition", syl: ["mal", "nu", "tri", "tion"], m: "ÁáüÈ§ä‰∏çËâØ (Not eating enough healthy food)" },
            { w: "alleviate", syl: ["al", "le", "vi", "ate"], m: "Á∑©Âíå/Ê∏õËºï (To make pain/problem less severe)" },
            { w: "complicated", syl: ["com", "pli", "ca", "ted"], m: "Ë§áÈõúÁöÑ (Difficult to understand)" }
        ]
    };

    // --- State Variables ---
    let session = {
        name: "", class: "", no: "", level: "",
        playlist: [], currentIdx: 0,
        results: [], // {word, speakScore, matchScore}
        scoreSpeak: 0, scoreMatch: 0
    };

    let attempts = 0;
    let recognition;
    let isSpeaking = false;

    // --- Initialization ---
    function startGame(level) {
        const name = document.getElementById('sName').value.trim();
        const cls = document.getElementById('sClass').value.trim();
        const no = document.getElementById('sNo').value.trim();

        if (!name || !cls || !no) {
            alert("Please fill in Name, Class, and Class No.");
            return;
        }

        session.name = name;
        session.class = cls;
        session.no = no;
        session.level = level;

        // Randomly select 10 words from the chosen category
        const allWords = vocabDB[level];
        // Shuffle and slice
        session.playlist = allWords
            .map(value => ({ value, sort: Math.random() }))
            .sort((a, b) => a.sort - b.sort)
            .map(({ value }) => value)
            .slice(0, 10);

        document.getElementById('screen-login').classList.add('hidden');
        document.getElementById('screen-game').classList.remove('hidden');

        initSpeech();
        loadLevel();
    }

    function initSpeech() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.toLowerCase();
                checkPronunciation(transcript);
            };

            recognition.onerror = () => {
                document.getElementById('mic-status').innerText = "‚ùå Error. Try again.";
                document.getElementById('mic-btn').classList.remove('mic-listening');
                isSpeaking = false;
            };

            recognition.onend = () => {
                document.getElementById('mic-btn').classList.remove('mic-listening');
                isSpeaking = false;
            };
        } else {
            alert("This browser does not support Speech Recognition. Please use Chrome.");
        }
    }

    // --- Game Logic ---
    function loadLevel() {
        if (session.currentIdx >= session.playlist.length) {
            endGame();
            return;
        }

        const currentData = session.playlist[session.currentIdx];
        
        // Update Stats
        document.getElementById('score-speak').innerText = session.scoreSpeak;
        document.getElementById('score-match').innerText = session.scoreMatch;
        document.getElementById('progress-text').innerText = `${session.currentIdx + 1}/${session.playlist.length}`;

        // Reset UI
        document.getElementById('task-speak').classList.remove('hidden');
        document.getElementById('task-match').classList.add('hidden');
        document.getElementById('feedback-speak').innerText = "";
        document.getElementById('mic-status').innerText = "Tap microphone to start";
        
        // Render Syllables
        const sylDiv = document.getElementById('word-syllables');
        sylDiv.innerHTML = "";
        currentData.syl.forEach((s, i) => {
            const span = document.createElement('span');
            // Skip spaces for coloring logic
            if(s.trim() === "") {
                span.innerText = s;
            } else {
                span.innerText = s;
                span.className = `syl-${(i % 5) + 1}`;
            }
            sylDiv.appendChild(span);
        });

        attempts = 0;
    }

    // --- Phase 1: Speaking ---
    function playTTS() {
        const word = session.playlist[session.currentIdx].w;
        const u = new SpeechSynthesisUtterance(word);
        u.rate = 0.85;
        window.speechSynthesis.speak(u);
    }

    function activateMic() {
        if (isSpeaking) return;
        if (recognition) {
            recognition.start();
            isSpeaking = true;
            document.getElementById('mic-btn').classList.add('mic-listening');
            document.getElementById('mic-status').innerText = "Listening...";
            document.getElementById('feedback-speak').innerText = "";
        }
    }

    function checkPronunciation(spoken) {
        const target = session.playlist[session.currentIdx].w.toLowerCase();
        // Remove special chars for comparison
        const cleanSpoken = spoken.replace(/[^a-z0-9 ]/g, "");
        const cleanTarget = target.replace(/[^a-z0-9 ]/g, "");

        if (cleanSpoken.includes(cleanTarget) || cleanTarget.includes(cleanSpoken)) {
            // Success
            document.getElementById('feedback-speak').innerText = `‚úÖ Correct! "${spoken}"`;
            document.getElementById('feedback-speak').style.color = "#388e3c";
            session.scoreSpeak++;
            session.results.push({ w: target, speak: 1, match: 0 }); // Init record
            setTimeout(startMatchPhase, 1500);
        } else {
            // Fail
            attempts++;
            if (attempts < 2) {
                document.getElementById('feedback-speak').innerText = `‚ö†Ô∏è Try again. You said: "${spoken}"`;
                document.getElementById('feedback-speak').style.color = "#f57c00";
            } else {
                document.getElementById('feedback-speak').innerText = `‚ùå Moving on. Word was: "${target}"`;
                document.getElementById('feedback-speak').style.color = "#d32f2f";
                session.results.push({ w: target, speak: 0, match: 0 }); // Init record
                setTimeout(startMatchPhase, 2000);
            }
        }
    }

    // --- Phase 2: Matching ---
    function startMatchPhase() {
        document.getElementById('task-speak').classList.add('hidden');
        document.getElementById('task-match').classList.remove('hidden');
        document.getElementById('feedback-match').innerText = "";
        attempts = 0;

        const correctObj = session.playlist[session.currentIdx];
        document.getElementById('match-word-title').innerText = correctObj.w;

        // Create options (Correct + 2 Distractors)
        // Get distractors from ANY level to ensure difficulty
        let pool = [...vocabDB.Core, ...vocabDB.Intermediate, ...vocabDB.Advanced];
        pool = pool.filter(item => item.w !== correctObj.w).sort(() => 0.5 - Math.random());
        
        let options = [correctObj, pool[0], pool[1]];
        options.sort(() => 0.5 - Math.random());

        const container = document.getElementById('options-container');
        container.innerHTML = "";

        options.forEach(opt => {
            const btn = document.createElement('div');
            btn.className = 'option-card';
            btn.innerText = opt.m;
            btn.onclick = () => checkMatch(btn, opt.w === correctObj.w);
            container.appendChild(btn);
        });
    }

    function checkMatch(btn, isCorrect) {
        // Prevent clicking if disabled
        if (btn.style.opacity === "0.5") return;

        if (isCorrect) {
            btn.style.background = "#c8e6c9";
            btn.style.borderColor = "#388e3c";
            document.getElementById('feedback-match').innerText = "‚úÖ Correct!";
            document.getElementById('feedback-match').style.color = "#388e3c";
            
            // Update current record
            let currentRes = session.results[session.results.length - 1];
            currentRes.match = 1;
            session.scoreMatch++;
            
            disableAllOptions();
            setTimeout(nextWord, 1000);
        } else {
            attempts++;
            btn.style.background = "#ffcdd2";
            btn.style.opacity = "0.5"; // Visual disable
            
            if (attempts < 2) {
                document.getElementById('feedback-match').innerText = "‚ö†Ô∏è Wrong meaning. Try again.";
                document.getElementById('feedback-match').style.color = "#f57c00";
            } else {
                document.getElementById('feedback-match').innerText = "‚ùå No attempts left.";
                document.getElementById('feedback-match').style.color = "#d32f2f";
                // Reveal correct
                disableAllOptions();
                setTimeout(nextWord, 1500);
            }
        }
    }

    function disableAllOptions() {
        const opts = document.querySelectorAll('.option-card');
        opts.forEach(o => {
            o.onclick = null;
            if (o.style.background !== "rgb(200, 230, 201)") { // If not green
                 o.style.opacity = "0.5";
            }
        });
    }

    function nextWord() {
        session.currentIdx++;
        loadLevel();
    }

    // --- End & Export ---
    function endGame() {
        document.getElementById('screen-game').classList.add('hidden');
        document.getElementById('screen-result').classList.remove('hidden');

        const total = session.scoreSpeak + session.scoreMatch;
        document.getElementById('final-score').innerText = total;

        const tbody = document.getElementById('result-tbody');
        tbody.innerHTML = "";
        session.results.forEach(r => {
            const tr = `<tr>
                <td>${r.w}</td>
                <td>${r.speak ? '‚úÖ' : '‚ùå'}</td>
                <td>${r.match ? '‚úÖ' : '‚ùå'}</td>
            </tr>`;
            tbody.innerHTML += tr;
        });
    }

    function exportCSV() {
        // BOM for Excel Chinese character support
        let csv = "\uFEFF";
        csv += "Student Name,Class,Class No,Date,Level,Word,Pronunciation (1/0),Matching (1/0),Total\n";
        
        const dateStr = new Date().toLocaleDateString();

        session.results.forEach(r => {
            csv += `"${session.name}","${session.class}","${session.no}","${dateStr}","${session.level}","${r.w}",${r.speak},${r.match},${r.speak + r.match}\n`;
        });

        // Summary Row
        csv += `SUMMARY,${session.class},${session.no},${dateStr},${session.level},ALL,${session.scoreSpeak},${session.scoreMatch},${session.scoreSpeak + session.scoreMatch}\n`;

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `${session.name}_Module4_Results.csv`;
        link.style.display = "none";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

</body>
</html>